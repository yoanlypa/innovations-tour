{% extends "pedidos/base.html" %}
{% load static %}

{% block content %}
<style>
  :root{
    --azul:#005dab;
    --azulOscuro:#004080;
  }
  .card-form{
    max-width:560px;margin:1.5rem auto;border-radius:1rem;
    box-shadow:0 8px 24px rgb(0 0 0 / .10);
  }
  .card-header{
    background:var(--azul);color:#fff;font-weight:600;
    border-radius:1rem 1rem 0 0
  }
  .maleta-box{
    border:1px solid #dee2e6;border-radius:.5rem;padding:.9rem;
    margin-bottom:1rem;position:relative
  }
  .maleta-box .btn-danger{
    position:absolute;top:.35rem;right:.35rem
  }
  .btn-primary{background:var(--azul);border:none}
  .btn-primary:hover{background:var(--azulOscuro)}
</style>

<div class="card-header text-center">
    {% if es_edicion %}‚úèÔ∏è Editar pedido{% else %}‚ûï Nuevo pedido{% endif %}
  </div>
  <div class="card-body">
    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <form method="POST" id="pedido-form">
      {% csrf_token %}
      {{ form.as_p }}

      <h5 class="mt-4">Maletas</h5>
      {{ formset.management_form }}

      <div id="maletas-container">
        {% for f in formset %}
        <div class="maleta-box">
          {{ f.id }}
          <div class="row g-3">
            <div class="col">
              {{ f.guia.label_tag }}{{ f.guia }}
            </div>
            <div class="col">
              {{ f.cantidad_pax.label_tag }}{{ f.cantidad_pax }}
            </div>
          </div>
          <input type="checkbox" name="maleta-{{ forloop.counter0 }}-DELETE"
                 id="id_maleta-{{ forloop.counter0 }}-DELETE" style="display:none">
          <button type="button" class="btn btn-danger btn-sm eliminar-maleta">üóë</button>
        </div>
        {% endfor %}
      </div>
      
      <button type="button" id="add-maleta" class="btn btn-outline-secondary mb-3">
        ‚ûï A√±adir maleta
      </button>

      <button class="btn btn-primary w-100">
        {% if es_edicion %}Actualizar{% else %}Guardar pedido{% endif %}
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const cont     = document.getElementById('maletas-container');
        const totalInp = document.getElementById('id_maleta-TOTAL_FORMS');
        const addBtn   = document.getElementById('add-maleta');
      
        const templateHTML = idx => `
          <div class="maleta-box">
            <div class="row g-3">
              <div class="col">
                <label>Gu√≠a</label>
                <input type="text" name="maleta-${idx}-guia" id="id_maleta-${idx}-guia"
                       class="form-control">
              </div>
              <div class="col">
                <label>Pax</label>
                <input type="number" name="maleta-${idx}-cantidad_pax"
                       id="id_maleta-${idx}-cantidad_pax"
                       class="form-control" min="1" value="1">
              </div>
            </div>
            <input type="checkbox" name="maleta-${idx}-DELETE"
                   id="id_maleta-${idx}-DELETE" style="display:none">
            <button type="button" class="btn btn-danger btn-sm eliminar-maleta">üóë</button>
          </div>`;
      
        function agregarMaleta(){
          const idx = parseInt(totalInp.value,10);
          cont.insertAdjacentHTML('beforeend', templateHTML(idx));
          totalInp.value = idx + 1;
        }
      
        /* Si el pedido nuevo llega sin maletas, a√±adimos la primera */
        if (parseInt(totalInp.value,10) === 0){
          agregarMaleta();
        }
      
        addBtn.addEventListener('click', agregarMaleta);
      
        cont.addEventListener('click', e=>{
          if(!e.target.classList.contains('eliminar-maleta')) return;
          const box = e.target.closest('.maleta-box');
          const del = box.querySelector('[name$=\"-DELETE\"]');
          del.checked = true;
          box.style.display = 'none';
        });
      });
      
</script>
{% endblock %}
