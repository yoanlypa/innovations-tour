{% extends "pedidos/base.html" %}
{% load static %}

{% block content %}
<style>
  .card-form{max-width:520px;margin:0 auto;border-radius:1rem;
             box-shadow:0 8px 24px rgb(0 0 0 / .12);}
  .card-header{background:#005dab;color:#fff;border-radius:1rem 1rem 0 0}
  .maleta-box{border:1px solid #dee2e6;border-radius:.5rem;padding:.75rem;margin-bottom:1rem}
  .btn-danger{float:right}
</style>

<div class="card card-form">
  <div class="card-header text-center">âž• Nuevo pedido</div>
  <div class="card-body">

    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <form method="POST" id="pedido-form">
      {% csrf_token %}
      {{ form.as_p }}

      <h5 class="mt-4">Maletas</h5>
      {{ formset.management_form }}

      <div id="maletas-container">
        {% for f in formset %}
        <div class="maleta-box">
          {{ f.id }}  {# hidden ID #}
          <div class="row">
            <div class="col">{{ f.guia.label_tag }}{{ f.guia }}</div>
            <div class="col">{{ f.cantidad_pax.label_tag }}{{ f.cantidad_pax }}</div>
          </div>
          <button type="button" class="btn btn-danger btn-sm eliminar-maleta">ðŸ—‘</button>
        </div>
        {% endfor %}
      </div>

      <button type="button" id="add-maleta" class="btn btn-secondary mb-3">âž• AÃ±adir maleta</button>

      <button class="btn btn-primary w-100">Guardar pedido</button>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const addBtn   = document.getElementById('add-maleta');
  const cont     = document.getElementById('maletas-container');
  const totalInp = document.getElementById('id_maleta-TOTAL_FORMS');
  const template = cont.querySelector('.maleta-box').cloneNode(true);

  // ----- AÃ±adir nueva maleta -----
  addBtn.addEventListener('click', () => {
    const idx = parseInt(totalInp.value);
    const clone = template.cloneNode(true);

    clone.querySelectorAll('input, select').forEach(el => {
      // sustituir Ã­ndices en name/id
      if (el.name) el.name = el.name.replace(/maleta-\\d+-/, `maleta-${idx}-`);
      if (el.id)   el.id   = el.id.replace(/maleta-\\d+-/, `maleta-${idx}-`);
      // reset valor
      if (el.type === 'number') el.value = 1;
      else if (el.type !== 'hidden') el.value = '';
    });
    // Quitar campo DELETE si existÃ­a
    const del = clone.querySelector('[name$=\"-DELETE\"]');
    if (del) del.checked = false;

    cont.appendChild(clone);
    totalInp.value = idx + 1;
  });

  // ----- Eliminar maleta -----
  cont.addEventListener('click', e => {
    if (!e.target.classList.contains('eliminar-maleta')) return;
    const box = e.target.closest('.maleta-box');
    const delInput = box.querySelector('[name$=\"-DELETE\"]');
    if (delInput){ delInput.checked = true; box.style.display = 'none'; }
  });
});
</script>
{% endblock %}
