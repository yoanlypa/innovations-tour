{% extends 'pedidos/base.html' %}

{% block content %}

        <button 
            type="button" 
            class="btn btn-primary btn-floating"
            data-bs-toggle="modal" 
            data-bs-target="#modalNuevaTarea"
        >
            ‚ûï
        </button>
    </div>
    <div class="container">
        <h1>Tareas</h1>
    
    <!-- Modal -->
    <div class="modal fade" id="modalNuevaTarea" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Tarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                ChatGPT Plus
                El c√≥digo AJAX que te proporcion√© debe colocarse en el archivo de plantilla donde tienes la l√≥gica del formulario para agregar nuevas tareas. En este caso, lo debes incluir en el archivo de plantilla que contiene el formulario en el modal de la nueva tarea, lo que ser√≠a el archivo tareas.html.
                
                A continuaci√≥n te indico los pasos espec√≠ficos para agregar el c√≥digo AJAX:
                
                Pasos para agregar el c√≥digo AJAX:
                Abre tu archivo tareas.html donde tienes el formulario para crear una nueva tarea.
                
                Encuentra la parte que tiene el formulario en el modal, donde los usuarios ingresan los datos de la tarea:
                
                html
                Copiar
                Editar
                <form method="POST" id="formNuevaTarea">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">T√≠tulo</label>
                            <input type="text" class="form-control" name="titulo" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea class="form-control" name="descripcion" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha Espec√≠fica</label>
                            <input type="date" class="form-control" name="fecha_especifica">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
    {% load fechas %}{% regroup tareas by fecha_especifica|date:"d/m/Y" as tareas_agrupadas %}
{% for grupo in tareas_agrupadas %}
    <div class="card mb-4 shadow">
        <div class="card-header bg-primary text-white">
            <h4>üìÖ {{ grupo.grouper }}</h4>
        </div>
        <div class="card-body">
            <div class="list-group">
                {% for tarea in grupo.list %}  <!-- Bucle de tareas por fecha -->
                    <div class="list-group-item">
                        <h5>{{ tarea.titulo }}</h5>
                        <p>{{ tarea.descripcion }}</p>
                        
                        <!-- Bot√≥n para cambiar estado (¬°Versi√≥n AJAX!) -->
                        <button 
                            type="button" 
                            class="btn btn-sm {% if tarea.completada %}btn-success{% else %}btn-warning{% endif %}"
                            data-tarea-id="{{ tarea.id }}"
                            onclick="cambiarEstado(this)"
                        >
                            {% if tarea.completada %}‚úÖ Realizada{% else %}‚è≥ Pendiente{% endif %}
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endfor %}

    


<!-- Script JS para que cambie de estado la tarea -->
<script>
async function cambiarEstado(boton) {
    const tareaId = boton.dataset.tareaId;
    try {
        const response = await fetch(`/pedidos/tareas/cambiar-estado/${tareaId}/`);
        if (response.ok) {
            const esRealizada = boton.textContent.includes('Realizada');
            boton.textContent = esRealizada ? '‚è≥ Pendiente' : '‚úÖ Realizada';
            boton.classList.toggle('btn-success');
            boton.classList.toggle('btn-warning');
        }
    } catch (error) {
        console.error('Error:', error);
    }
}
     // Script JS para agregar la tarea nueva -->
     <script>
        document.getElementById('formNuevaTarea').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch("{% url 'pedidos:tarea_nueva' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });
                
                if (response.ok) {
                    // Aseg√∫rate de esperar la respuesta antes de recargar la p√°gina
                    const data = await response.json();
                    if (data.success) {
                        window.location.reload();  // Recarga la p√°gina
                    }
                } else {
                    console.error("Error en la respuesta del servidor:", response.status);
                }
            } catch (error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
        </script>
            

{% endblock %}
