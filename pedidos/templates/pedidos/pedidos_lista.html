{% extends 'pedidos/base.html' %}

{% block content %}
  <h2 class="mb-4" style="color:#005dab;">üì¶ Lista de Pedidos</h2>

  {% if not user.is_staff %}
    <div class="alert alert-warning">
      <strong>‚ö†Ô∏è AVISO:</strong> No tienes permiso para ver esta p√°gina.
    </div>
  {% else %}
    {# ‚Äî‚Äî Borrado masivo ‚Äî‚Äî #}
    <form id="mass-delete-form"
          method="post"
          action="{% url 'pedidos:pedido_eliminar_masivo' %}">
      {% csrf_token %}
      <button type="submit"
              class="btn btn-danger mb-3"
              onclick="return confirm('¬øEliminar todos los seleccionados?');">
        üóëÔ∏è Eliminar seleccionados
      </button>

      {% if pedidos %}
        <div class="table-responsive shadow-sm rounded-3 overflow-hidden">
          <table class="table table-striped align-middle text-center">
            <thead class="table-light" style="background-color: #005dab; color: white;">
              <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Empresa</th>
                <th>Excursi√≥n</th>
                <th>Lugar Entrega</th>
                <th>Lugar Recogida</th>
                <th>Maletas</th>
                <th>Estado</th>
                <th>Notas</th>
                <th>Editar</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody>
              {% for p in pedidos %}
                <tr>
                  {# Checkbox de selecci√≥n #}
                  <td>
                    <input type="checkbox"
                           name="selected_ids"
                           value="{{ p.pk }}"
                           class="select-checkbox">
                  </td>

                  <td>{{ p.fecha_inicio|date:"d/m/Y" }}</td>
                  <td>{{ p.fecha_fin|date:"d/m/Y"|default:"‚Äî" }}</td>
                  <td>{{ p.empresa }}</td>
                  <td>{{ p.excursion|default:"‚Äî" }}</td>
                  <td>{{ p.lugar_entrega }}</td>
                  <td>{{ p.lugar_recogida|default:"‚Äî" }}</td>
                  <td>
                    {% for m in p.maletas.all %}
                      <span class="badge rounded-pill text-bg-light border shadow-sm d-block mb-1">
                        üéí {{ m.cantidad_pax }} pax / Gu√≠a: {{ m.guia }}
                      </span>
                    {% empty %}
                      ‚Äî
                    {% endfor %}
                  </td>
                  <td>
                    <button
                      class="btn
                        {% if p.estado == 'pendiente_pago' %}
                          btn-outline-secondary
                        {% elif p.estado == 'pagado' %}
                          btn-success
                        {% elif p.estado == 'aprobado' %}
                          btn-primary
                        {% elif p.estado == 'entregado' %}
                          btn-info text-dark
                        {% elif p.estado == 'recogido' %}
                          btn-dark
                        {% else %}
                          btn-outline-secondary
                        {% endif %}
                      btn-estado"
                      data-pk="{{ p.pk }}"
                      data-url="{% url 'pedidos_cambiar_estado' p.pk %}">
                      {{ p.get_estado_display }}
                    </button>
                              </td>
                  <td>
                    {% if p.notas %}
                      <button class="btn btn-sm btn-outline-info"
                              data-bs-toggle="tooltip"
                              title="{{ p.notas }}">
                        üìù
                      </button>
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td>
                    <a href="{% url 'pedidos:pedido_editar' p.pk %}"
                       class="btn btn-sm"
                       style="background-color:#f78243; color:white;">
                      ‚úèÔ∏è Editar
                    </a>
                  </td>
                  <td>
                    <button type="submit"
                            class="btn btn-sm btn-danger"
                            form="delete-form-{{ p.pk }}"
                            onclick="return confirm('¬øEliminar este pedido?');">
                      üóëÔ∏è
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-info text-center">
          No hay pedidos registrados.
        </div>
      {% endif %}
    </form>

    {# ‚Äî‚Äî Formularios ocultos para borrado individual ‚Äî‚Äî #}
    {% for p in pedidos %}
      <form id="delete-form-{{ p.pk }}"
            method="post"
            action="{% url 'pedidos:pedido_eliminar' p.pk %}"
            style="display:none;">
        {% csrf_token %}
      </form>
    {% endfor %}

  {% endif %}
{% endblock %}


{% block scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Inicializar tooltips de Bootstrap
      const triggers = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      triggers.forEach(el => new bootstrap.Tooltip(el));

      // Checkbox ‚ÄúSeleccionar todos‚Äù
      const selectAll = document.getElementById('select-all');
      selectAll && selectAll.addEventListener('change', () => {
        document.querySelectorAll('.select-checkbox')
                .forEach(cb => cb.checked = selectAll.checked);
      });
    });
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.btn-estado').forEach(boton => {
      boton.addEventListener('click', async function () {
        const url = this.dataset.url;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        // Pregunta de confirmaci√≥n:
        const { isConfirmed } = await Swal.fire({
          title: '¬øEst√°s seguro?',
          text: `Cambiar estado de "${this.textContent.trim()}" al siguiente paso?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'S√≠, cambiar',
          cancelButtonText: 'Cancelar'
        });
        if (!isConfirmed) return;

        // Si confirma, llamamos al AJAX:
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken }
          });
          const data = await res.json();
          // Actualiza texto y clases
          this.textContent = data.display;
          this.className = 'btn ' + data.badge_class + ' btn-estado';
        } catch (err) {
          console.error('Error cambiando estado:', err);
          Swal.fire('Error', 'No se pudo cambiar el estado.', 'error');
        }
      });
    });
  });
  </script>
{% endblock %}
