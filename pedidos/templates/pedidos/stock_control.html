{% extends 'pedidos/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üì¶ Control de Stock</h2>
        <div>
            <a href="{% url 'pedidos:exportar_csv' %}" class="btn btn-secondary me-2">
                üì• Exportar CSV
            </a>
            <a href="{% url 'pedidos:agregar_stock' %}" class="btn btn-primary">
                ‚ûï Nuevo Registro
            </a>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Excursi√≥n</th>
                    <th>Empresa</th>
                    <th>Fechas</th>
                    <th>Maletas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in object_list %}
                <tr>
                    <td>{{ stock.excursion }}</td>
                    <td>{{ stock.empresa }}</td>
                    <td>{{ stock.fecha_inicio|date:"d/m/Y" }} - {{ stock.fecha_fin|date:"d/m/Y" }}</td>
                    <td>
                        {% for maleta in stock.maletas.all %}
                        <span class="badge bg-secondary">üéí {{ maleta.guia }} ({{ maleta.pax }} pax)</span>
                        {% endfor %}
                    </td>
                        <button class="btn btn-sm {% if registro.entregado %}btn-success{% else %}btn-primary{% endif %} btn-estado"
                                data-url="{% url 'pedidos:toggle_estado' pk=registro.pk %}">
                            {% if registro.entregado %}üì§ Entregado{% else %}üì• Recogido{% endif %}
                        </button>
                    </td>
                    <td>
                        <a href="{% url 'pedidos:editar_stock' registro.pk %}" class="btn btn-sm btn-warning">
                            ‚úèÔ∏è Editar
                        </a>
                        <button class="btn btn-sm btn-danger btn-eliminar" 
                                data-url="{% url 'pedidos:eliminar_stock' registro.pk %}">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Toggle Estado
    document.querySelectorAll('.btn-estado').forEach(button => {
        button.addEventListener('click', async function() {
            const confirmacion = await Swal.fire({
                title: '¬øCambiar estado?',
                text: 'Esta acci√≥n modificar√° el registro',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar'
            });
            
            if (!confirmacion.isConfirmed) return;

            try {
                const response = await fetch(this.dataset.url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.classList.toggle('btn-success');
                    this.classList.toggle('btn-primary');
                    this.textContent = data.entregado ? 'üì§ Entregado' : 'üì• Recogido';
                }
            } catch (error) {
                Swal.fire('Error', 'No se pudo actualizar el estado', 'error');
            }
        });
    });

    // Eliminar Registro
    document.querySelectorAll('.btn-eliminar').forEach(button => {
        button.addEventListener('click', async function() {
            const confirmacion = await Swal.fire({
                title: '¬øEliminar registro?',
                text: 'Esta acci√≥n no se puede deshacer',
                icon: 'error',
                showCancelButton: true,
                confirmButtonText: 'Eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545'
            });
            
            if (confirmacion.isConfirmed) {
                try {
                    await fetch(this.dataset.url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    });
                    window.location.reload();
                } catch (error) {
                    Swal.fire('Error', 'No se pudo eliminar el registro', 'error');
                }
            }
        });
    });
});
</script>
{% endblock %}