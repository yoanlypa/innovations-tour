{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 style="color:#005dab;">üì¶ Control de Stock</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal">
      ‚ûï Nuevo Registro
    </button>
  </div>

   <!-- ‚îÄ‚îÄ‚îÄ Tabla de registros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Inicio</th><th>Fin</th><th>Excursi√≥n</th><th>Empresa</th>
          <th>Lugar E</th><th>Lugar R</th><th>Estado</th><th>Gu√≠a</th>
          <th>Creaci√≥n</th><th>Maletas</th><th>Notas</th><th>Entrega</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in registros %}
        <tr>
          <td>{{ stock.fecha_inicio|date:"d/m/Y" }}</td>
          <td>{{ stock.fecha_fin|date:"d/m/Y" }}</td>
          <td>{{ stock.excursion }}</td>
          <td>{{ stock.empresa }}</td>
          <td>{{ stock.lugar_entrega }}</td>
          <td>{{ stock.lugar_recogida }}</td>
          <td>{{ stock.get_estado_display }}</td>
          <td>{{ stock.guia }}</td>
          <td>{{ stock.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>
            {% for maleta in stock.maletas.all %}
              <span class="badge bg-secondary">üéí {{ maleta.guia }} ({{ maleta.cantidad_pax }})</span>
            {% empty %}‚Äî{% endfor %}
          </td>
          <td>
            {% if stock.notas %}
              <button class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="{{ stock.notas }}">üìù</button>
            {% else %}‚Äî{% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-estado" data-url="{% url 'pedidos:toggle_estado_stock' stock.pk %}">
              {% if stock.entregado %}
                <span class="badge bg-success">Entregado</span>
              {% else %}
                <span class="badge bg-primary">Recogido</span>
              {% endif %}
            </button>
          </td>
          <td>
            <a href="{% url 'pedidos:editar_stock' stock.pk %}" class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
            <button class="btn btn-sm btn-danger btn-eliminar" data-url="{% url 'pedidos:eliminar_stock' stock.pk %}">üóëÔ∏è</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>


  <!-- Modal Nuevo Registro -->
  <div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">‚ûï Nuevo Registro de Control de Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="stock-form" method="post" action="{% url 'pedidos:agregar_stock' %}">
            {% csrf_token %}

            <!-- Selecci√≥n de pedido -->
            <div class="mb-3">
              <label for="pedidoSelector" class="form-label">Selecciona pedido pagado</label>
              <select id="pedidoSelector" name="pedido" class="form-select" required>
                <option value="">-- Selecciona --</option>
                {% for pedido in pedidos_pagados %}
                  <option value="{{ pedido.id }}">{{ pedido.empresa }} ‚Äì {{ pedido.fecha_inicio|date:"d/m/Y" }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Campos editables -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label for="id_fecha_inicio">Fecha inicio*</label>
                <input type="date" name="fecha_inicio" id="id_fecha_inicio" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="id_fecha_fin">Fecha fin</label>
                <input type="date" name="fecha_fin" id="id_fecha_fin" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_excursion">Excursi√≥n</label>
                <input type="text" name="excursion" id="id_excursion" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_empresa">Empresa</label>
                <input type="text" name="empresa" id="id_empresa" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_lugar_entrega">Lugar de entrega</label>
                <input type="text" name="lugar_entrega" id="id_lugar_entrega" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_lugar_recogida">Lugar de recogida</label>
                <input type="text" name="lugar_recogida" id="id_lugar_recogida" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_guia">Gu√≠a</label>
                <input type="text" name="guia" id="id_guia" class="form-control">
              </div>
              <div class="col-md-6">
                <label for="id_estado">Estado</label>
                <select name="estado" id="id_estado" class="form-select">
                  <option value="G" selected>Pagado</option>
                  <option value="P">Pendiente</option>
                </select>
              </div>
              <div class="col-12">
                <label for="id_notas">Notas</label>
                <textarea name="notas" id="id_notas" class="form-control"></textarea>
              </div>
            </div>

            <!-- Gesti√≥n de maletas -->
            <div class="border p-3 mb-4 rounded">
              <h6 style="color:#005dab;">üéí Gesti√≥n de Maletas</h6>
              {{ formset.management_form }}
              <div id="maletas-container">
                {% for mform in formset %}
                  <div class="maleta-form mb-3 p-2 border rounded">
                    {{ mform.id }}
                    <div class="row g-2">
                      <div class="col-md-6">{{ mform.guia.label_tag }} {{ mform.guia }}</div>
                      <div class="col-md-5">{{ mform.pax.label_tag }}  {{ mform.pax }}</div>
                      <div class="col-md-1">{{ mform.DELETE.label_tag }} {{ mform.DELETE }}</div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <button type="button" id="add-maleta" class="btn btn-secondary mt-2">
                ‚ûï A√±adir Maleta
              </button>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success">üíæ Guardar Todo</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
  let formIndex = parseInt($('#id_form-TOTAL_FORMS').val(), 10);

  function renderMaletas(maletas) {
    const $c = $('#maletas-container');
    $c.empty();
    formIndex = 0;
    maletas.forEach(m => {
      const row = `
        <div class="maleta-form mb-3 p-2 border rounded">
          <input type="hidden" name="form-${formIndex}-id"/>
          <div class="row g-2">
            <div class="col-md-6">
              <label>Gu√≠a:</label>
              <input type="text" name="form-${formIndex}-guia"
                     class="form-control" value="${m.guia}">
            </div>
            <div class="col-md-5">
              <label>PAX:</label>
              <input type="number" name="form-${formIndex}-pax"
                     class="form-control" value="${m.pax}">
            </div>
            <div class="col-md-1">
              <label>Eliminar</label>
              <input type="checkbox" name="form-${formIndex}-DELETE">
            </div>
          </div>
        </div>`;
      $c.append(row);
      formIndex++;
    });
    $('#id_form-TOTAL_FORMS').val(formIndex);
  }

  $('#pedidoSelector').on('change', function() {
    const id = $(this).val();
    if (!id) return;
    $.getJSON("{% url 'pedidos:cargar_datos_pedido' %}", { pedido_id: id })
      .done(data => {
        $('#id_fecha_inicio').val(data.fecha_inicio.split('T')[0]);
        $('#id_fecha_fin').val(data.fecha_fin ? data.fecha_fin.split('T')[0] : '');
        $('#id_excursion').val(data.excursion);
        $('#id_empresa').val(data.empresa);
        $('#id_lugar_entrega').val(data.lugar_entrega);
        $('#id_lugar_recogida').val(data.lugar_recogida);
        $('#id_guia').val(data.guia);
        $('#id_estado').val(data.estado);
        $('#id_notas').val(data.notas);
        renderMaletas(data.maletas);
      })
      .fail(() => alert('Error al cargar datos del pedido'));
  });

  $('#add-maleta').click(() => {
    const html = `
      <div class="maleta-form mb-3 p-2 border rounded">
        <input type="hidden" name="form-${formIndex}-id"/>
        <div class="row g-2">
          <div class="col-md-6">
            <label>Gu√≠a:</label>
            <input type="text" name="form-${formIndex}-guia" class="form-control">
          </div>
          <div class="col-md-5">
            <label>PAX:</label>
            <input type="number" name="form-${formIndex}-pax" class="form-control">
          </div>
          <div class="col-md-1">
            <label>Eliminar</label>
            <input type="checkbox" name="form-${formIndex}-DELETE">
          </div>
        </div>
      </div>`;
    $('#maletas-container').append(html);
    formIndex++;
    $('#id_form-TOTAL_FORMS').val(formIndex);
  });

  $('#stock-form').submit(async function(e) {
    e.preventDefault();
    const fd = new FormData(this);
    try {
      const resp = await fetch(this.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': fd.get('csrfmiddlewaretoken') },
        body: fd
      });
      if (!resp.ok) throw new Error(await resp.text());
      bootstrap.Modal.getInstance($('#nuevoRegistroModal')[0]).hide();
      location.reload();
    } catch (err) {
      alert('Error al guardar: ' + err.message);
    }
  });
});
</script>
{% endblock %}
