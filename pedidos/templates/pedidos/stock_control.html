{% extends 'pedidos/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">

  <!-- ‚îÄ‚îÄ‚îÄ Encabezado con bot√≥n de nuevo registro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üì¶ Control de Stock</h2>
    <div>
      <!-- Bot√≥n que abre el modal -->
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal">
        ‚ûï Nuevo registro
      </button>
      <a href="{% url 'pedidos:exportar_csv' %}" class="btn btn-secondary ms-2">üì• Exportar CSV</a>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Aqu√≠ va *solo* la tabla de registros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Excursi√≥n</th><th>Empresa</th><th>Fechas</th>
          <th>Maletas</th><th>Estado</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in registros %}
        <tr>
          <td>{{ stock.excursion }}</td>
          <td>{{ stock.empresa }}</td>
          <td>{{ stock.fecha_inicio|date:"d/m/Y" }} ‚Äì {{ stock.fecha_fin|date:"d/m/Y" }}</td>
          <td>
            {% for maleta in stock.maletas.all %}
              <span class="badge bg-secondary">üéí {{ maleta.guia }} ({{ maleta.cantidad_pax }})</span>
            {% endfor %}
          </td>
          <td>
            <button class="btn btn-sm btn-estado"
                    data-url="{% url 'pedidos:toggle_estado' stock.pk %}">
              {% if stock.entregado %}
                <span class="badge bg-success">Entregado</span>
              {% else %}
                <span class="badge bg-primary">Recogido</span>
              {% endif %}
            </button>
          </td>
          <td>
            <a href="{% url 'pedidos:editar_stock' stock.pk %}" class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
            <button class="btn btn-sm btn-danger btn-eliminar" data-url="{% url 'pedidos:eliminar_stock' stock.pk %}">
              üóëÔ∏è Eliminar
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Modal para "Nuevo registro" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="form-nuevo-stock" method="post" action="{% url 'pedidos:agregar_stock' %}">
          {% csrf_token %}
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">‚ûï Nuevo Control de Stock</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            {{ form|crispy }}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>  {# /container #}

<!-- ‚îÄ‚îÄ‚îÄ Scripts AJAX y Bootstrap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
  // Toggle estado
  document.querySelectorAll('.btn-estado').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const resp = await fetch(btn.dataset.url, {
          method: 'POST',
          headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        });
        const data = await resp.json();
        btn.innerHTML = data.entregado
          ? '<span class="badge bg-success">Entregado</span>'
          : '<span class="badge bg-primary">Recogido</span>';
      } catch {
        alert('No se pudo cambiar estado');
      }
    });
  });

  // Env√≠o AJAX del formulario del modal
  document.getElementById('form-nuevo-stock').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this, data = new FormData(form);
    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
        body: data
      });
      if (!resp.ok) throw new Error();
      bootstrap.Modal.getInstance(document.getElementById('nuevoRegistroModal')).hide();
      form.reset();
      location.reload();   // recarga la tabla
    } catch {
      alert('Error al guardar');
    }
  });
</script>

<!-- Bootstrap JS (si a√∫n no lo has cargado) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
