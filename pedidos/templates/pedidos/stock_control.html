{% extends 'base.html' %}
{% load static %}

{% block content %}
<h2>Agregar Control de Stock</h2>

<form method="post">
    {% csrf_token %}
    <label for="pedido_id">Seleccionar pedido pagado:</label>
    <select id="pedido_id" name="pedido_id">
        <option value="">--- Selecciona un pedido ---</option>
        {% for pedido in pedidos_pagados %}
            <option value="{{ pedido.id }}">Pedido #{{ pedido.id }} - {{ pedido.empresa.nombre }}</option>
        {% endfor %}
    </select>

    {{ form.as_p }}

    <div id="maletas_container"></div>

    <button type="submit">Guardar</button>
</form>

<script>
document.getElementById('pedido_id').addEventListener('change', function() {
    const pedidoId = this.value;
    if (!pedidoId) return;

    fetch("{% url 'pedidos:cargar_datos_pedido' %}?pedido_id=" + pedidoId)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Rellenar campos
            document.getElementById('id_empresa').value = data.empresa;
            document.getElementById('id_lugar_inicio').value = data.lugar_inicio;
            document.getElementById('id_lugar_fin').value = data.lugar_fin;
            document.getElementById('id_fecha_entrega').value = data.fecha_entrega;
            document.getElementById('id_fecha_retiro').value = data.fecha_retiro;

            const maletasContainer = document.getElementById('maletas_container');
            maletasContainer.innerHTML = '';
            data.maletas.forEach((maleta, index) => {
                maletasContainer.innerHTML += `
                    <p>
                        <label>Maleta ${index + 1}</label><br>
                        Cantidad: <input type="number" name="maletas_${index}_cantidad" value="${maleta.cantidad}">
                        Gu√≠a: <input type="text" name="maletas_${index}_guia" value="${maleta.guia__nombre}">
                    </p>
                `;
            });
        });
});
</script>
{% endblock %}
