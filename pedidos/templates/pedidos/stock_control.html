{% extends "pedidos/base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üì¶ Control de Stock</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal">
      ‚ûï Nuevo Registro
    </button>
  </div>

  <div class="table-responsive mb-5">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th>Inicio</th><th>Fin</th><th>Excursi√≥n</th><th>Empresa</th>
          <th>Lugar E</th><th>Lugar R</th><th>Estado</th><th>Gu√≠a</th>
          <th>Creaci√≥n</th><th>Maletas</th><th>Notas</th><th>Entrega</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for stock in registros %}
        <tr>
          <td>{{ stock.fecha_inicio|date:"d/m/Y" }}</td>
          <td>{{ stock.fecha_fin|date:"d/m/Y" }}</td>
          <td>{{ stock.excursion }}</td>
          <td>{{ stock.empresa }}</td>
          <td>{{ stock.lugar_entrega }}</td>
          <td>{{ stock.lugar_recogida }}</td>
          <td>{{ stock.get_estado_display }}</td>
          <td>{{ stock.guia }}</td>
          <td>{{ stock.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>
            {% for m in stock.maletas.all %}
              <span class="badge bg-secondary">üéí {{ m.guia }} ({{ m.cantidad_pax }})</span>
            {% empty %}‚Äî
            {% endfor %}
          </td>
          <td>
            {% if stock.notas %}
              <button class="btn btn-sm btn-info"
                      data-bs-toggle="tooltip"
                      title="{{ stock.notas }}">üìù</button>
            {% else %}‚Äî
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-estado"
                    data-url="{% url 'pedidos:toggle_estado_stock' stock.pk %}">
              {% if stock.entregado %}
                <span class="badge bg-success">Entregado</span>
              {% else %}
                <span class="badge bg-primary">Recogido</span>
              {% endif %}
            </button>
          </td>
          <td>
            <a href="{% url 'pedidos:editar_stock' stock.pk %}"
               class="btn btn-sm btn-warning">‚úèÔ∏è</a>
            <button class="btn btn-sm btn-danger btn-eliminar"
                    data-url="{% url 'pedidos:eliminar_stock' stock.pk %}">üóëÔ∏è</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Nuevo Registro -->
<div class="modal fade" id="nuevoRegistroModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚ûï Nuevo Registro de Control de Stock</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="stock-form" method="post" action="{% url 'pedidos:agregar_stock' %}">
          {% csrf_token %}

          <!-- 1) Selector de Pedido -->
          <div class="mb-3">
            <label class="form-label">Pedido pagado*</label>
            <select id="pedidoSelector" name="pedido" class="form-select" required>
              <option value="">-- Selecciona --</option>
              {% for pedido in pedidos_pagados %}
                <option value="{{ pedido.id }}">
                  {{ pedido.empresa }} ‚Äì {{ pedido.fecha_inicio|date:"d/m/Y" }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- 2) Campos principales -->
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label>Fecha inicio*</label>
              <input type="date" name="fecha_inicio" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Fecha fin</label>
              <input type="date" name="fecha_fin" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Excursi√≥n</label>
              <input type="text" name="excursion" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Empresa</label>
              <input type="text" name="empresa" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Lugar de entrega</label>
              <input type="text" name="lugar_entrega" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Lugar de recogida</label>
              <input type="text" name="lugar_recogida" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Gu√≠a</label>
              <input type="text" name="guia" class="form-control">
            </div>
            <div class="col-md-6">
              <label>Estado</label>
              <select name="estado" class="form-select">
                <option value="G" selected>Pagado</option>
                <option value="P">Pendiente</option>
              </select>
            </div>
            <div class="col-12">
              <label>Notas</label>
              <textarea name="notas" class="form-control"></textarea>
            </div>
          </div>

          <!-- 3) Gesti√≥n de maletas -->
          <div class="border p-3 mb-4 rounded">
            <h6>üéí Gesti√≥n de Maletas</h6>
            {{ formset.management_form }}
            <div id="maletas-container">
              {% for mform in formset %}
                <div class="maleta-form mb-3 p-2 border rounded">
                  {{ mform.id }}
                  <div class="row g-2">
                    <div class="col-md-6">
                      {{ mform.guia.label_tag }} {{ mform.guia }}
                    </div>
                    <div class="col-md-5">
                      {{ mform.cantidad_pax.label_tag }} {{ mform.cantidad_pax }}
                    </div>
                    <div class="col-md-1">
                      {{ mform.DELETE.label_tag }} {{ mform.DELETE }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            <button type="button" id="add-maleta" class="btn btn-secondary mt-2">
              ‚ûï A√±adir Maleta
            </button>
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success">üíæ Guardar Todo</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
  // Toggle Entregado/Recogido
  $('.btn-estado').click(async function(){
    const btn = $(this),
          url = btn.data('url');
    const res = await fetch(url, {
      method:'POST',
      headers:{ 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() }
    });
    const d = await res.json();
    btn.html(
      d.entregado
        ? '<span class="badge bg-success">Entregado</span>'
        : '<span class="badge bg-primary">Recogido</span>'
    );
  });

  // Precarga de pedido
  $('#pedidoSelector').change(function(){
    const id = $(this).val();
    if(!id) return;
    $.getJSON("{% url 'pedidos:cargar_datos_pedido' %}", {pedido_id:id})
      .done(data=>{
        $('[name="fecha_inicio"]').val(data.fecha_inicio.split('T')[0]);
        $('[name="fecha_fin"]').val(data.fecha_fin?.split('T')[0]||'');
        $('[name="excursion"]').val(data.excursion);
        $('[name="empresa"]').val(data.empresa);
        $('[name="lugar_entrega"]').val(data.lugar_entrega);
        $('[name="lugar_recogida"]').val(data.lugar_recogida);
        $('[name="guia"]').val(data.guia);
        $('[name="estado"]').val(data.estado);
        $('[name="notas"]').val(data.notas);
        renderMaletas(data.maletas);
      })
      .fail(()=>alert('Error cargando datos del pedido'));
  });

  // Formset din√°mico
  <script>
    $(function(){
      // lectura inicial del TOTAL_FORMS con prefix="form"
      let formIndex = parseInt($('#id_form-TOTAL_FORMS').val(),10);
    
      // a√±adir maleta nueva
      $('#add-maleta').click(function(){
        const html = `
          <div class="maleta-form mb-3 p-2 border rounded">
            <input type="hidden" name="form-${formIndex}-id" id="id_form-${formIndex}-id"/>
            <div class="row g-2">
              <div class="col-md-6">
                <label>Gu√≠a:</label>
                <input type="text" name="form-${formIndex}-guia" class="form-control" id="id_form-${formIndex}-guia"/>
              </div>
              <div class="col-md-5">
                <label>PAX:</label>
                <input type="number" name="form-${formIndex}-cantidad_pax" class="form-control" id="id_form-${formIndex}-cantidad_pax"/>
              </div>
              <div class="col-md-1">
                <label>Eliminar</label>
                <input type="checkbox" name="form-${formIndex}-DELETE" id="id_form-${formIndex}-DELETE"/>
              </div>
            </div>
          </div>`;
        $('#maletas-container').append(html);
        formIndex++;
        $('#id_form-TOTAL_FORMS').val(formIndex);
      });
    
      // submit AJAX
      $('#stock-form').submit(async function(e){
        e.preventDefault();
        const fd = new FormData(this);
        const resp = await fetch(this.action, {
          method: 'POST',
          headers: {'X-CSRFToken': fd.get('csrfmiddlewaretoken')},
          body: fd
        });
        if(resp.ok){
          bootstrap.Modal.getInstance($('#nuevoRegistroModal')[0]).hide();
          location.reload();
        } else {
          const err = await resp.json();
          console.error(err);
          alert('Error al guardar. Mira la consola.');
        }
      });
    });
    </script>
</script>
{% endblock %}
