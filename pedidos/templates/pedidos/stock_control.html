{% extends 'pedidos/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">

  <!-- ‚îÄ‚îÄ‚îÄ Encabezado con bot√≥n de nuevo registro ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üì¶ Control de Stock</h2>
    <div>
      <!-- Bot√≥n que abre el modal -->
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoRegistroModal">
        ‚ûï Nuevo registro
      </button>
      <a href="{% url 'pedidos:exportar_csv' %}" class="btn btn-secondary ms-2">üì• Exportar CSV</a>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Aqu√≠ va *solo* la tabla de registros ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-dark">
        <thead class="table-dark">
            <tr>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Excursi√≥n</th>
              <th>Empresa</th>
              <th>Lugar E</th>
              <th>Lugar R</th>
              <th>Estado</th>
              <th>Gu√≠a</th>
              <th>Creaci√≥n</th>
              <th>Maletas</th>
              <th>Notas</th>
              <th>Entrega</th>
              <th>Acciones</th>
            </tr>
          </thead>
          
      </thead>
      <tbody>
        {% for stock in registros %}
        <tr>
          <td>{{ stock.fecha_inicio|date:"d/m/Y" }}</td>
          <td>{{ stock.fecha_fin|date:"d/m/Y" }}</td>
          <td>{{ stock.excursion }}</td>
          <td>{{ stock.empresa }}</td>
          <td>{{ stock.lugar_entrega }}</td>
          <td>{{ stock.lugar_recogida }}</td>
          <td>{{ stock.estado }}</td>
          <td>{{ stock.guia }}</td>
          <td>{{ stock.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>
            {% for maleta in stock.maletas.all %}
              <span class="badge bg-secondary">üéí {{ maleta.guia }} ({{ maleta.cantidad_pax }})</span>
            {% empty %}
              ‚Äî
            {% endfor %}
          </td>
          <td>
            {% if stock.notas %}
              <button class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="{{ stock.notas }}">
                üìù
              </button>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-estado"
                    data-url="{% url 'pedidos:toggle_estado' stock.pk %}">
              {% if stock.entregado %}
                <span class="badge bg-success">Entregado</span>
              {% else %}
                <span class="badge bg-primary">Recogido</span>
              {% endif %}
            </button>
          </td>
          <td>
            <a href="{% url 'pedidos:editar_stock' stock.pk %}" class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
            <button class="btn btn-sm btn-danger btn-eliminar"
                    data-url="{% url 'pedidos:eliminar_stock' stock.pk %}">
              üóëÔ∏è
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ Modal para "Nuevo registro" ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
 <!-- Bot√≥n para abrir el modal -->
<button class="btn btn-primary mb-3"
data-bs-toggle="modal"
data-bs-target="#nuevoRegistroModal">
‚ûï Nuevo registro
</button>

<div class="modal-header bg-primary text-white">
    <h3 class="modal-title">‚ûï Nuevo Registro de Control de Stock</h3>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
  </div>
  <form method="post" id="stock-form" action="{% url 'pedidos:agregar_stock' %}">
    {% csrf_token %}
    <div class="modal-body">
      <!-- Campos principales -->
      <div class="form-group">
        <label>Selecciona Pedido Pagado</label>
        <select id="pedidoSelector" class="form-control" required>
          <option value="">-- Selecciona --</option>
          {% for pedido in pedidos_pagados %}
          <option value="{{ pedido.id }}">{{ pedido.empresa }} - {{ pedido.fecha_inicio }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        {{ form.pedido.label_tag }}
        {{ form.pedido }}
    </div>
    
      <div class="row g-3">
        <div class="col-md-6">
          <label>Fecha inicio*</label>
          <input type="date" name="fecha_inicio" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label>Fecha fin</label>
          <input type="date" name="fecha_fin" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Excursi√≥n</label>
          <input type="text" name="excursion" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Empresa</label>
          <input type="text" name="empresa" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Lugar de entrega</label>
          <input type="text" name="lugar_entrega" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Lugar de recogida</label>
          <input type="text" name="lugar_recogida" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Gu√≠a</label>
          <input type="text" name="guia" class="form-control">
        </div>
        <div class="col-md-6">
          <label>Estado</label>
          <select name="estado" class="form-select">
            <option value="G" selected>Pagado</option>
            <option value="P">Pendiente</option>
          </select>
        </div>
        <div class="col-12">
          <label>Notas</label>
          <textarea name="notas" class="form-control"></textarea>
        </div>
      </div>
  
      <!-- Din√°mica de maletas -->
      <hr>
      <div class="mb-3">
        <label>N√∫mero de maletas*</label>
        <input type="number" id="nroMaletas" name="nroMaletas" min="1" value="1" class="form-control">
      </div>
      <div id="maletas-container"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      <button type="submit" class="btn btn-success">Guardar</button>
    </div>
  </form>
  

<!-- ‚îÄ‚îÄ‚îÄ Scripts AJAX y Bootstrap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
  // Toggle estado
  document.querySelectorAll('.btn-estado').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const resp = await fetch(btn.dataset.url, {
          method: 'POST',
          headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        });
        const data = await resp.json();
        btn.innerHTML = data.entregado
          ? '<span class="badge bg-success">Entregado</span>'
          : '<span class="badge bg-primary">Recogido</span>';
      } catch {
        alert('No se pudo cambiar estado');
      }
    });
  });
  
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (el) {
      new bootstrap.Tooltip(el)
    })
  
  // Env√≠o AJAX del formulario del modal
  document.getElementById('formStockControl').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this, data = new FormData(form);
    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
        body: data
      });
      if (!resp.ok) throw new Error();
      bootstrap.Modal.getInstance(document.getElementById('nuevoRegistroModal')).hide();
      form.reset();
      location.reload();   // recarga la tabla
    } catch {
      alert('Error al guardar');
    }
  });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('formStockControl');
      const nroMaletas = document.getElementById('nroMaletas');
      const container  = document.getElementById('maletas-container');
    
      // Genera campos de maleta
      function renderMaletas(count) {
        container.innerHTML = '';
        for(let i=0; i<count; i++){
          const div = document.createElement('div');
          div.className = 'maleta-group border p-3 mb-2 rounded';
          div.innerHTML = `
              <h6>Maleta ${i+1}</h6>
              <div class="row g-3">
                <div class="col-md-6">
                  <label>Cantidad pax*</label>
                  <input type="number" name="maletas-${i}-cantidad_pax" min="1" required class="form-control">
                </div>
                <div class="col-md-6">
                  <label>Gu√≠a*</label>
                  <input type="text" name="maletas-${i}-guia" required class="form-control">
                </div>
              </div>
            `;
          container.appendChild(div);
        }
      }
    
      nroMaletas.addEventListener('input', () => {
        renderMaletas(parseInt(nroMaletas.value)||1);
      });
    
      renderMaletas(parseInt(nroMaletas.value)||1);
    
      // Env√≠o AJAX
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const data = new FormData(form);
        // A√±ade total de maletas al payload si tu vista lo necesita
        data.set('total_maletas', nroMaletas.value);
    
        try {
          const resp = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
            body: data
          });
          if(!resp.ok) throw new Error(await resp.text());
          // Cierra modal y recarga lista
          bootstrap.Modal.getInstance(document.getElementById('nuevoRegistroModal')).hide();
          form.reset();
          renderMaletas(1);
          location.reload();
        } catch(err) {
          alert('Error: '+ err.message);
          console.error(err);
        }
      });
    });
    </script>
    <script>
      document.getElementById('pedidoSelector').addEventListener('change', function () {
          const pedidoId = this.value;
          if (!pedidoId) return;
      
          fetch(`/api/pedido/${pedidoId}/datos/`)
              .then(response => response.json())
              .then(data => {
                  document.getElementById('empresa').value = data.empresa;
                  document.getElementById('lugar_entrega').value = data.lugar_entrega;
                  document.getElementById('lugar_recogida').value = data.lugar_recogida || '';
                  document.getElementById('fecha_inicio').value = data.fecha_inicio;
                  document.getElementById('fecha_fin').value = data.fecha_fin || '';
      
                  const container = document.getElementById('maletas-container');
                  container.innerHTML = '';
                  data.maletas.forEach((maleta, index) => {
                      container.innerHTML += `
                          <div class="maleta-group">
                              <h5>Maleta ${index + 1}</h5>
                              <div class="form-group">
                                  <label>Cantidad Pax</label>
                                  <input type="number" name="maletas-${index}-cantidad" value="${maleta.cantidad_pax}" class="form-control" required>
                              </div>
                              <div class="form-group">
                                  <label>Gu√≠a</label>
                                  <input type="text" name="maletas-${index}-guia" value="${maleta.guia}" class="form-control" required>
                              </div>
                          </div>`;
                  });
              })
              .catch(error => alert('Error cargando datos del pedido'));
      });

      document.getElementById('pedidoSelector').addEventListener('change', async function () {
        const pedidoId = this.value;
        if (!pedidoId) return;
      
        try {
          const resp = await fetch(`/api/pedidos/${pedidoId}/`);
          if (!resp.ok) throw new Error('No se pudo cargar el pedido');
          const data = await resp.json();
      
          document.querySelector('[name="empresa"]').value = data.empresa;
          document.querySelector('[name="lugar_entrega"]').value = data.lugar_entrega;
          document.querySelector('[name="lugar_recogida"]').value = data.lugar_recogida;
          document.querySelector('[name="fecha_inicio"]').value = data.fecha_inicio;
          document.querySelector('[name="fecha_fin"]').value = data.fecha_fin;
      
          // Rellenar maletas
          const nro = data.maletas.length;
          document.getElementById('nroMaletas').value = nro;
          renderMaletas(nro);
          data.maletas.forEach((m, i) => {
            document.querySelector(`[name="maletas-${i}-cantidad_pax"]`).value = m.cantidad_pax;
            document.querySelector(`[name="maletas-${i}-guia"]`).value = m.guia;
          });
      
        } catch (e) {
          alert('Error al precargar los datos del pedido.');
        }
      });
      
      </script>
      

      <script>
        // 1) Inicializa el √≠ndice del formset seg√∫n el management_form
        let formIndex = parseInt($('#id_form-TOTAL_FORMS').val());
      
        // 2) Bot√≥n ‚ûï A√±adir Maleta (din√°mico)
        $('#add-maleta').click(function () {
          const newForm = `
            <div class="maleta-form mb-3 p-2 border rounded">
              <input type="hidden" name="form-${formIndex}-id" />
              <div class="row g-2">
                <div class="col-md-6">
                  <label for="id_form-${formIndex}-guia">Gu√≠a:</label>
                  <input type="text" name="form-${formIndex}-guia" class="form-control" />
                </div>
                <div class="col-md-5">
                  <label for="id_form-${formIndex}-pax">PAX:</label>
                  <input type="number" name="form-${formIndex}-pax" class="form-control" />
                </div>
                <div class="col-md-1">
                  <label for="id_form-${formIndex}-DELETE">Eliminar</label>
                  <input type="checkbox" name="form-${formIndex}-DELETE" />
                </div>
              </div>
            </div>`;
          $('#maletas-container').append(newForm);
          formIndex++;
          $('#id_form-TOTAL_FORMS').val(formIndex);
        });
      
        // 3) Precarga datos del pedido pagado al cambiar el <select>
        $('#id_pedido').change(function () {
          const pedidoId = $(this).val();
          if (!pedidoId) return;
      
          $.ajax({
            url: "{% url 'cargar_datos_pedido' %}",
            data: { pedido_id: pedidoId },
            success: function (data) {
              // Rellenar campos principales
              $('#id_empresa').val(data.empresa);
              $('#id_lugar_entrega').val(data.lugar_entrega);
              $('#id_lugar_recogida').val(data.lugar_recogida);
              $('#id_fecha_inicio').val(data.fecha_inicio);
              $('#id_fecha_fin').val(data.fecha_fin);
      
              // Vaciar formset de maletas y volver a crear seg√∫n response
              $('#maletas-container').empty();
              formIndex = 0;
              data.maletas.forEach(function(maleta) {
                const formHtml = `
                  <div class="maleta-form mb-3 p-2 border rounded">
                    <input type="hidden" name="form-${formIndex}-id" />
                    <div class="row g-2">
                      <div class="col-md-6">
                        <label for="id_form-${formIndex}-guia">Gu√≠a:</label>
                        <input type="text" name="form-${formIndex}-guia" class="form-control" value="${maleta.guia}" />
                      </div>
                      <div class="col-md-5">
                        <label for="id_form-${formIndex}-pax">PAX:</label>
                        <input type="number" name="form-${formIndex}-pax" class="form-control" value="${maleta.pax}" />
                      </div>
                      <div class="col-md-1">
                        <label for="id_form-${formIndex}-DELETE">Eliminar</label>
                        <input type="checkbox" name="form-${formIndex}-DELETE" />
                      </div>
                    </div>
                  </div>`;
                $('#maletas-container').append(formHtml);
                formIndex++;
              });
              $('#id_form-TOTAL_FORMS').val(formIndex);
            },
            error: function () {
              alert('No se pudieron cargar los datos del pedido.');
            }
          });
        });
      </script>
<!-- Bootstrap JS (si a√∫n no lo has cargado) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
